function mule_upload(e){function t(e){var t=this;e=e||{},t.input=e.file_input,t.file=e.file,e.chunk_size=e.chunk_size||6*o,e.max_size=e.max_size||50*(1<<30),e.num_workers=e.num_workers||3,e.key=e.key||"the_key",e.bucket=e.bucket,e.protocol=e.protocol||window.location.protocol||"http:",e.host=e.host||e.protocol+"//"+e.bucket+".s3.amazonaws.com",e.access_key=e.access_key,e.content_type=e.content_type||"application/octet-stream",e.acl=e.acl||"public-read",e.on_progress=e.on_progress||function(){},e.on_select=e.on_select||function(){},e.on_error=e.on_error||function(){},e.on_complete=e.on_complete||function(){},e.on_init=e.on_init||function(){},e.on_start=e.on_start||function(){},e.on_chunk_uploaded=e.on_chunk_uploaded||function(){},e.ajax_base=e.ajax_base||"/upload-backend",e.accepted_extensions=e.accepted_extensions||"",t.settings=e,t.set_state("waiting"),t.input&&(t.input.onchange=function(e,n){if("waiting"!=t.get_state())return!1;var i=e.target.files[0];t.upload_file(i,n)}),setTimeout(function(){t.settings.on_init.apply(t)},100)}var n=!0,i=function(){};n&&console&&console.log&&(i=function(){for(var e=["[MuleUploader]"],t=0;t<arguments.length;t++)e.push(arguments[t]);return console.log.apply(console,e)});var s=function(e){e.headers=e.headers||{},e.method=e.method||"GET";var t=new XMLHttpRequest;e.load_callback&&"function"==typeof e.load_callback&&t.addEventListener("load",e.load_callback,!0),e.error_callback&&"function"==typeof e.error_callback&&t.addEventListener("error",e.error_callback,!0),e.state_change_callback&&"function"==typeof e.state_change_callback&&t.addEventListener("readystatechange",e.state_change_callback),e.progress_callback&&"function"==typeof e.progress_callback&&t.upload.addEventListener("progress",e.progress_callback),e.timeout_callback&&"function"==typeof e.timeout_callback&&t.addEventListener("timeout",timeout_callback),t.open(e.method,e.url);for(var n in e.headers)t.setRequestHeader(n,e.headers[n]);return e.body?t.send(e.body):t.send(),t},a=1024,o=1024*a,r=1024*o;if(File.prototype.slice=File.prototype.webkitSlice||File.prototype.mozSlice||File.prototype.slice,!(window.File&&window.FileList&&window.Blob))return-1;if(-1!==navigator.userAgent.indexOf("Firefox"))try{new Blob(["something"])}catch(l){return-1}return i("OK"),t.prototype.upload_file=function(t,n){i("Start upload file: "+t.name);var a=this;if("waiting"!=a.get_state())return!1;if(t&&(a.file=t),!a.file)return!1;if(a.file.lastModifiedDate=a.file.lastModifiedDate||new Date(0),a.file.size>a.settings.max_size)return void alert("The maximum allowed file size is "+a.settings.max_size/r+"GB. Please select another file.");if(a.settings.accepted_extensions){var o=t.name.split(".").pop();extensions_array=a.settings.accepted_extensions.split(",");for(var l=!1,u=0;u<extensions_array.length;u++)if(o==extensions_array[u]){l=!0;break}if(!l)return void alert("This file format is not accepted. Please use a file with an extension like '"+a.settings.accepted_extensions)}a.get_init_signature(function(i,o){if(a.upload_id)n?a.get_all_signatures(function(){a.load_file(t)}):a.list_parts(function(){a.get_all_signatures(function(){a.load_file(t)})},function(){return a.upload_id=null,this._loaded_chunks=null,a._progress=null,a._loaded_chunks=null,a._uploading_chunks=null,a._chunks=null,a.upload_file(t,!0)});else{var r="AWS "+e.access_key+":"+i,l=function(e){a.settings.on_select.call(a,t);var n=e.target.responseXML;a.upload_id=n.getElementsByTagName("UploadId")[0].textContent,a.get_all_signatures(function(){a.load_file(t)})};s({method:"POST",url:e.host+"/"+e.key+"?uploads",load_callback:l,error_callback:l,headers:{"x-amz-date":o,"x-amz-acl":e.acl,Authorization:r,"Content-Type":a.settings.content_type,"Content-Disposition":"attachment; filename="+clean_filename(a.file.name)}})}},n)},t.prototype.load_file=function(e){var t=this;if("waiting"==t.get_state()){t._start_fired||(t.settings.on_start.call(t,t.file),t.settings.on_progress.call(t,0,t.file.size),t._start_fired=!0),t.set_state("processing"),t.settings.on_progress.call(t,t.get_total_progress(),t.file.size);var n=t.get_next_chunk();-1!=n?t.upload_chunk(n):t.upload_finished()&&(i("All done; finish upload"),t.finish_upload());for(var s=0;s<t.settings.num_workers-1&&(n=t.get_next_chunk(),-1!==n);s++)t.upload_chunk(n)}},t.prototype.upload_chunk=function(e){var t=this;return"processing"!=t.get_state()?void i("NOT processing; return"):t.get_chunk_uploading(e)?(i("Already Uploading"),void setTimeout(function(){var e=t.get_next_chunk();-1!==e&&t.get_all_signatures(function(){t.upload_chunk(t.get_next_chunk())})},1e3)):(t.set_chunk_uploading(e),i("Uploading Chunk: "+e),void t.get_chunk_signature(e,function(n,a){var o=t.settings.chunk_size,r=e*o,l=Math.min(r+o,t.file.size),u=new Date;if(t._intervals=t._intervals||{},t.is_chunk_loaded(e)){var _=t.get_next_chunk();-1!=_?t.upload_chunk(_):t.upload_finished()&&(i("No next chunk; finish upload"),t.finish_upload())}var c=function(n){if(n.target.readyState!=this.DONE||"processing"!=t.get_state())return void i(n);if(n.target.status/100!=2)return h();i("Chunk uploaded: "+e),t.notify_chunk_uploaded(e),t.settings.on_chunk_uploaded.call(t,e),clearInterval(t._intervals[e]),t.set_chunk_finished(e),t.set_chunk_uploading(e,!1);var s=t.get_next_chunk();if(-1!=s)i("More chunks to upload"),t.upload_chunk(s);else if(t.upload_finished())i("Done - all chunks uploaded"),t.finish_upload();else{i("No next chunk to upload, but not finished");var a=setInterval(function(){if(t.upload_finished())i("Oh, it is finished"),clearInterval(a);else{var e=t.get_next_chunk();-1!==e?(i("Finally got next chunk"),clearInterval(a),t.upload_chunk(e)):i("Still no next chunk")}},1e3)}},d=function(n){t.set_progress(e,n.loaded),t.settings.on_progress.call(t,t.get_total_progress(),t.file.size),u=new Date},p=!1,h=function(){var n=arguments,s=this;t.check_already_uploaded(function(){t.set_state("finished"),t.notify_upload_finished(),t.settings.on_progress.call(t,t.file.size,t.file.size),t.settings.on_complete.call(t)},function(){if(i("Error: "),i(n),!p){p=!0,t.set_chunk_uploading(e,!1),i("Abort"),i(s);try{s.abort()}catch(a){i(a)}i("Retry chunk: "+e),clearInterval(t._intervals[e]),setTimeout(function(){if("processing"==t.get_state()){var e=t.get_next_chunk();-1!==e&&t.get_all_signatures(function(){t.upload_chunk(t.get_next_chunk())})}},1e3)}})},g="/"+t.settings.key;g+="?partNumber="+(e+1)+"&uploadId="+t.upload_id;var f="AWS "+t.settings.access_key+":"+n,k=t.file.slice(r,l),y=s({method:"PUT",url:t.settings.host+g,progress_callback:d,state_change_callback:c,error_handler:h,timeout_handler:h,headers:{"x-amz-date":a,Authorization:f,"Content-Type":t.settings.content_type,"Content-Disposition":"attachment; filename="+clean_filename(t.file.name)},body:k});window.xhrs=window.xhrs||[],window.xhrs.push(y),t._chunk_xhr=t._chunk_xhr||[],t._chunk_xhr.push(y),t._intervals[e]=setInterval(function(){u&&new Date-u>15e3&&(i("Chunk Failed; retry"),clearInterval(t._intervals[e]),"processing"==t.get_state()&&(y.abort(),h.call(y)))},4e3)}))},t.prototype.finish_upload=function(){i("Finish upload");var e=this;"processing"==e.get_state()&&(e.set_state("finishing"),e.settings.on_progress.call(e,e.file.size,e.file.size),this.get_end_signature(function(t,n){var a="/"+e.settings.key+"?uploadId="+e.upload_id,o="AWS "+e.settings.access_key+":"+t,r=function(t){i("Finish upload response: ",t),t.target.status/100==2?(i("Finished file."),e.set_state("finished"),e.settings.on_progress.call(e,e.file.size,e.file.size),e.notify_upload_finished(),e.settings.on_complete.call(e)):400==t.target.status&&-1!==t.target.responseText.indexOf("EntityTooSmall")?e.list_parts(function(t){e.update_chunks(t);var n=e.get_next_chunk();e.set_state("processing"),e.upload_chunk(n)}):404==t.target.status?e.cancel(function(){e.upload_file(e.file,!0)}):e.check_already_uploaded(function(){r({target:{status:200}})},function(){r({target:{status:404}})})};e.list_parts(function(t){var i=Math.ceil(e.file.size/e.settings.chunk_size);if(t.length!=i){e.update_chunks(t);var l=e.get_next_chunk();return e.set_state("processing"),void e.upload_chunk(l)}for(var u="<CompleteMultipartUpload>",_=0;_<t.length;_++)u+="<Part>",u+="<PartNumber>"+t[_][0]+"</PartNumber>",u+="<ETag>"+t[_][1]+"</ETag>",u+="</Part>";u+="</CompleteMultipartUpload>",-1!==navigator.userAgent.indexOf("Firefox")&&(u=new Blob([u])),s({url:e.settings.host+a,method:"POST",load_callback:r,error_callback:r,headers:{"x-amz-date":n,Authorization:o,"Content-Type":e.settings.content_type,"Content-Disposition":"attachment; filename="+clean_filename(e.file.name)},body:u})})}))},t.prototype.list_parts=function(e,t,n){var i=this;i.get_list_signature(function(a,o){var r=function(n){if(n.target.status/100!=2&&t)return t(n);for(var s=n.target.responseXML,a=[],o=s.getElementsByTagName("Part"),r=Math.ceil(i.file.size/i.settings.chunk_size),l=0;l<o.length;l++){var u=parseInt(o[l].getElementsByTagName("PartNumber")[0].textContent,10),_=o[l].getElementsByTagName("ETag")[0].textContent,c=parseInt(o[l].getElementsByTagName("Size")[0].textContent,10);(u==r||c==i.settings.chunk_size)&&(u!=r||c==i.file.size%i.settings.chunk_size)&&a.push([u,_,c])}var d=s.getElementsByTagName("IsTruncated")[0].textContent;if("true"===d){var p=s.getElementsByTagName("NextPartNumberMarker")[0].textContent;i.list_parts(function(t){e(a.concat(t))},t,p)}else e(a)},l="/"+i.settings.key+"?uploadId="+i.upload_id;n&&(l=l+"&part-number-marker="+n);var u="AWS "+i.settings.access_key+":"+a;s({method:"GET",load_callback:r,url:i.settings.host+l,headers:{"x-amz-date":o,Authorization:u}})})},t.prototype.get_end_signature=function(e){var t=this;if(t._end_signature)return void e(t._end_signature[0],t._end_signature[1]);var n=function(t){var n=JSON.parse(t.target.responseText);e(n.signature,n.date)},i=function(){setTimeout(function(){t.get_end_signature(e)},1e3)},a=t.settings.ajax_base+"/get_end_signature/?upload_id="+escape(this.upload_id)+"&key="+this.settings.key;s({url:a,load_callback:n,error_callback:i})},t.prototype.get_list_signature=function(e,t){var n=this;if(t=t||function(){},n._list_signature)return void e(n._list_signature[0],n._list_signature[1]);var i=function(t){var n=JSON.parse(t.target.responseText);e(n.signature,n.date)},a=function(t){setTimeout(function(){n.get_list_signature(e)},1e3)},o=n.settings.ajax_base+"/get_list_signature/?upload_id="+escape(this.upload_id)+"&key="+this.settings.key;s({load_callback:i,error_callback:a,url:o})},t.prototype.get_chunk_signature=function(e,t){var n=this;if(n._chunk_signatures&&n._chunk_signatures[e+1])return void t(n._chunk_signatures[e+1][0],n._chunk_signatures[e+1][1]);var i=function(e){var n=JSON.parse(e.target.responseText);t(n.signature,n.date)},a=function(i){setTimeout(function(){n.get_chunk_signature(e,t)},1e3)},o=n.settings.ajax_base+"/get_chunk_signature/?chunk="+(e+1)+"&upload_id="+escape(this.upload_id)+"&key="+this.settings.key;s({load_callback:i,error_callback:a,url:o})},t.prototype.get_init_signature=function(e,t){var n=this,a=Math.ceil(n.file.size/n.settings.chunk_size),o=function(t){var s=JSON.parse(t.target.responseText);if(s.chunks){if(s.chunks.length==a)return i(s.chunks.length,a),n.get_init_signature(e,!0);i("Resume upload...");var o=s.chunks;n._progress=n._progress||[];for(var r=0;r<o.length;r++)i("Chunk already uploaded: "+(o[r]-1)),n._progress[o[r]]=n.settings.chunk_size,n.add_loaded_chunk(o[r]-1),n.set_chunk_finished(o[r]-1),n.bytes_started=(n.bytes_started||0)+n.settings.chunk_size;n.upload_id=s.upload_id,n.settings.key=s.key}e(s.signature,s.date)},r=function(){i("Failed; trying again"),setTimeout(function(){n.get_init_signature(e)},1e3)},l=n.settings.ajax_base+"/get_init_signature/?key="+n.settings.key+"&mime_type="+escape(n.settings.content_type)+"&filename="+escape(clean_filename(n.file.name))+"&filesize="+n.file.size+"&last_modified="+n.file.lastModifiedDate.valueOf()+(t?"&force=true":"");s({url:l,load_callback:o,error_callback:r})},t.prototype.get_all_signatures=function(e){var t=this,n=t.settings.key,i=Math.ceil(t.file.size/t.settings.chunk_size),a=t.upload_id,o=function(n){var i=JSON.parse(n.target.responseText);t._chunk_signatures=i.chunk_signatures,t._list_signature=i.list_signature,t._end_signature=i.end_signature,t._delete_signature=i.delete_signature,e()},r=function(){setTimeout(function(){t.get_all_signatures(e)},1e3)},l=t.settings.ajax_base+"/get_all_signatures/?key="+n+"&mime_type="+escape(t.settings.content_type)+"&num_chunks="+i+"&upload_id="+a+"&filename="+escape(clean_filename(t.file.name))+"&filesize="+t.file.size+"&last_modified="+t.file.lastModifiedDate.valueOf();s({url:l,load_callback:o,error_callback:r})},t.prototype.notify_chunk_uploaded=function(e){var t=this;if("processing"==t.get_state()){var n=t.settings.key,i=t.upload_id,a=t.settings.ajax_base+"/chunk_loaded/?key="+n+"&chunk="+(e+1)+"&upload_id="+i+"&filename="+escape(clean_filename(t.file.name))+"&filesize="+t.file.size+"&last_modified="+t.file.lastModifiedDate.valueOf();s({url:a})}},t.prototype.notify_upload_finished=function(e){var t=this;if("finished"==t.get_state()){var n=t.settings.key,i=t.upload_id,a=t.settings.ajax_base+"/upload_finished/?key="+n+"&upload_id="+i+"&filename="+escape(clean_filename(t.file.name))+"&filesize="+t.file.size+"&last_modified="+t.file.lastModifiedDate.valueOf();s({url:a})}},t.prototype.check_already_uploaded=function(e,t){var n=this,a="/"+n.settings.key,o=function(n){n.target.status/100==2?(i("Already Uploaded"),e()):(i("Error!"),t())};t||"function"==typeof t||(t=function(){setTimeout(function(){return n.check_already_uploaded(e,t)},2500)}),s({url:n.settings.host+a,method:"HEAD",load_callback:o,error_callback:t})},t.prototype.cancel=function(e){for(var t=this,n=0;n<t._chunk_xhr.length;n++)i("Abort chunk: "+t._chunk_xhr[n]),t._chunk_xhr[n].abort();t._intervals=t._intervals||{};for(var s in t._intervals)clearInterval(t._intervals[s]);e=e||function(){},t.set_state("canceled"),t._chunk_xhr=t._chunk_xhr||[],t.settings.on_progress.call(t,0,0),t._chunk_xhr=null,t._chunks=null,t._uploading_chunks=null,t._loaded_chunks=null,t._start_fired=!1,t.upload_id=null,t._progress=null,t._chunk_signatures=null,t._list_signature=null,t._end_signature=null,t._delete_signature=null,t.set_state("waiting"),e()},t.prototype.update_chunks=function(e){var t=this,n=[],s=Math.ceil(t.file.size/t.settings.chunk_size);t._init_chunks(!0),t._uploading_chunks=[],t._loaded_chunks=[];for(var a=0;a<e.length;a++){var o=parseInt(e[a][0],10);t.add_loaded_chunk(o-1),t.set_chunk_finished(o-1),n.push(o-1)}i(n);for(var a=0;s>a;a++)-1===n.indexOf(a)&&(i("Chunk not uploaded: ",a),t.set_progress(a,0))},t.prototype.is_selected=function(){return!!this.file},t.prototype.get_state=function(){return this._state},t.prototype.set_state=function(e){return this._state=e},t.prototype.set_progress=function(e,t){Math.ceil(this.file.size/this.settings.chunk_size);this.log_status(),this._progress=this._progress||{},this._progress[e]=t},t.prototype.get_total_progress=function(){var e=0;for(var t in this._progress)e+=this._progress[t];return e},t.prototype.is_chunk_loaded=function(e){return this._loaded_chunks=this._loaded_chunks||[],-1!==this._loaded_chunks.indexOf(e)},t.prototype.add_loaded_chunk=function(e){this._loaded_chunks=this._loaded_chunks||[],this._loaded_chunks.push(e),this.set_progress(e,this.get_chunk_size(e))},t.prototype.get_chunk_uploading=function(e){return this._uploading_chunks=this._uploading_chunks||[],-1!==this._uploading_chunks.indexOf(e)},t.prototype.set_chunk_uploading=function(e,t){if("undefined"==typeof t&&(t=!0),this._uploading_chunks=this._uploading_chunks||[],t)this._uploading_chunks.push(e);else{for(var n=[],i=0;i<this._uploading_chunks.length;i++)this._uploading_chunks[i]!=e&&n.push(this._uploading_chunks[i]);this._uploading_chunks=n}},t.prototype._init_chunks=function(e){var t=this;if(!t._chunks||e){t._chunks=[];for(var n=Math.ceil(t.file.size/t.settings.chunk_size),i=0;n>i;i++)t._chunks.push(!1)}},t.prototype.set_chunk_finished=function(e,t){"undefined"==typeof t&&(t=!0);var n=this;n._init_chunks(),n._chunks[e]=t},t.prototype.get_next_chunk=function(){var e=this;e._init_chunks();for(var t=0;t<e._chunks.length;t++)if(!e._chunks[t]&&!e.get_chunk_uploading(t))return t;return-1},t.prototype.upload_finished=function(){var e=this;e._init_chunks();for(var t=0;t<e._chunks.length;t++)if(!e._chunks[t]||e.get_chunk_uploading(t))return!1;return!0},t.prototype.is_last_chunk=function(e){return Math.ceil(this.file.size/this.settings.chunk_size)==e-1},t.prototype.get_chunk_size=function(e){return this.is_last_chunk(e)?this.file.size%this.settings.chunk_size:this.settings.chunk_size},t.prototype.log_status=function(){},t.prototype.on_progress=function(e){u.settings.on_progress=e},t.prototype.on_select=function(e){u.settings.on_select=e},t.prototype.on_error=function(e){u.settings.on_error=e},t.prototype.on_complete=function(e){u.settings.on_complete=e},t.prototype.on_init=function(e){u.settings.on_init=e},t.prototype.on_start=function(e){u.settings.on_start=e},t.prototype.on_chunk_uploaded=function(e){u.settings.on_chunk_uploaded=e},new t(e)}function clean_filename(e){return file_name=e.substr(0,e.lastIndexOf("."))||e,ext=e.split(".").pop(),file_name.replace(/\W/g,"_")+"."+ext}